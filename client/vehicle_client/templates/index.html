{% extends "layout.html" %}
	
{% block head %}
<script src="https://unpkg.com/hyperapp@1.2.8/dist/hyperapp.js"></script>
<script src="https://unpkg.com/@hyperapp/router@0.7.0/dist/router.js"></script>
<script src="https://unpkg.com/@hyperapp/html@1.1.1/dist/hyperappHtml.js"></script>
{% endblock %}

{% block content %}
<script>
const main = (()=>{

// Using the Intl API so europe gets 24 hour, ect.
const time_format = new Intl.DateTimeFormat(navigator.lanuage,
{
  hour: "numeric",
  minute: "numeric"
});

const date_format = new Intl.DateTimeFormat(navigator.lanuage,
{
  day: "numeric",
  month: "long",
  year: "numeric"
});

function formatTime(t) {
  const time = t == undefined ? new Date() : new Date(t);
  return time_format.format(time);
}

function formatDate(t) {
  const time = t == undefined ? new Date() : new Date(t);
  return date_format.format(time);
}

// Imports
const {Link, Route, location} = hyperappRouter
const {main, h1, span, div, button, section, img, article, time, a} = hyperappHtml;

const state = {
	location: location.state,
	test: "bird is the word",
	apps: []
}

const actions = {
	location: location.actions,
	load_apps: new_apps => state => ({apps: new_apps})
}

const app_short = (app) => (
	article({class: "M(s03) P(s02) Bxsh(0,0,s05,grey-5) Bdrus(s05) Bgc(white) D(f) Ai(c) Fld(c)"}, [
		img({
			src: "http://localhost:5000/api/v1/app/" + app.id + "/icon",
			class: "Maw(60%) D(b) Bdrus(s05)"
		}),
		Link({
			to: "/" + app.id,
			class: "_rLink() C(blue) Op(.7):h Fz(s3)"
		}, app.name),
		div({class: "Ellip() Ov(h) W(100%)"}, app.description),
		time({class: "Ff(Inconsolata)"}, "Updated " + formatDate(app.updated))
	])
)

const app_long = (app) => (
	article({class: "M(s03) P(s1) Bxsh(0,0,s05,grey-5) Bdrus(s05) Bgc(white) D(f) Ai(c) Fld(c)"}, [
		img({
			src: "http://localhost:5000/api/v1/app/" + app.id + "/icon",
			class: "Maw(100%) D(b) Bdrus(s05)"
		}),
		Link({
			to: "/" + app.id,
			class: "_rLink() C(#191919) Fz(s4)"
		}, app.name),
		div({class: "Lh(1.5) P (s03)"}, app.description),
		time({class: "Ff(Inconsolata)"}, "Updated " + formatDate(app.updated))
	])
)

const home = () => (state, actions) => (
	section({}, [
		h1({class: "Ta(c)"}, "Apps"),
			Array.from(state.apps.values()).map(app_short)
	])
);

const detail = ({match, _}) => (state, actions) => (
	section({}, [
		h1({class: "Ta(c)"}, "Apps"),
			app_long(state.apps.get(parseInt(match.params["app_id"])))
	])
);

const installed = () => (
	h1("Installed")
);

const view = (state, actions) => (
	main({class: "Mx(a) W(100%) W(60%)@md W(40%)@lg H(100%) Maw(50rem)"}, [
		div({class: "D(f) Jc(space-evenly) P(s04) Fz(s3)"}, [
			Link({to: "/installed", class: "_rLink() C(grey-2) P(s04) C(blue):h"}, "Installed Apps"),
			Link({to: "/", class: "_rLink() C(grey-2) P(s04) C(blue):h"}, "Home")
		]),
		Route({path: "/",  render: home}),
		Route({path: `/:app_id`,  render: detail}),
		Route({path: "/installed", render: installed})
	])
)

return hyperapp.app(state, actions, view, document.body)
})();

hyperappRouter.location.subscribe(main.location);

$.get("http://localhost:5000/api/v1/app", "json", apps => {
	app_map = new Map()
	for (let app of apps) {
		app_map.set(app.id, app)
	}
	console.log(app_map);
	window.app_map = app_map;
	main.load_apps(app_map);
})
</script>

{% endblock %}